<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listagem de Referências</title>
</head>
<body>
<h2>Listagem de Referências</h2>

<ul id="referenceList"></ul>

<script>
    // Função para fazer a requisição GET
    function fetchReferences() {
        fetch("http://localhost:9999/")
        .then(response => response.json())
        .then(data => {
            // Limpa a lista de referências
            var referenceList = document.getElementById("referenceList");
            referenceList.innerHTML = "";

            // Itera sobre os resultados retornados e os adiciona à lista
            data.forEach(reference => {
                var listItem = document.createElement("li");
                listItem.innerHTML = `
                    <strong>Title:</strong> ${reference.title}<br>
                    <strong>Description:</strong> ${reference.description}<br>
                    <strong>Franchise Name:</strong> ${reference.franchiseName}<br>
                    <a href="#" onclick="downloadImage(${reference.referenceId})">Download Image</a><br>
                    <img src="data:image/png;base64,${arrayBufferToBase64(reference.rawThumbnailData)}" alt="Thumbnail">
                `;
                referenceList.appendChild(listItem);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again later.');
        });
    }

    // Função para fazer o download da imagem
    function downloadImage(id) {
        fetch(`http://localhost:9999/download/${id}`)
        .then(response => response.json())
        .then(data => {
            // Cria um novo blob com os bytes da imagem
            var blob = new Blob([data.rawImageBytes], { type: "image/png" });

            // Cria um URL temporário para o blob
            var url = window.URL.createObjectURL(blob);

            // Cria um link <a> para iniciar o download do arquivo
            var link = document.createElement("a");
            link.href = url;
            link.download = "image.png";

            // Adiciona o link à página e simula o clique para iniciar o download
            document.body.appendChild(link);
            link.click();

            // Remove o link da página
            document.body.removeChild(link);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again later.');
        });
    }

    // Função para converter ArrayBuffer para base64
    function arrayBufferToBase64(buffer) {
        var binary = '';
        var bytes = new Uint8Array(buffer);
        var len = bytes.byteLength;
        for (var i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    }

    // Chama a função fetchReferences quando a página é carregada
    window.onload = fetchReferences;
</script>
</body>
</html>